/**
 * 演者名のバリデーションと正規化ユーティリティ
 *
 * 全クローラーで共通して使用する演者名の検証・正規化ロジック
 */

/**
 * 無効な演者名のパターン
 */
const INVALID_PATTERNS: RegExp[] = [
  // 数字のみ
  /^[0-9]+$/,
  // 短い英数字のみ（3文字未満、または数字・記号のみ）
  // 注: Anna, Lisa などの4文字外国人名は許可
  /^[a-zA-Z0-9_-]{1,2}$/,
  // 素人系の一般名称
  /^素人[0-9]*$/,
  // 企画もの
  /^企画$/,
  // 「他」単体
  /^他$/,
  // 矢印で始まる（変換ミス）
  /^→/,
  // 矢印を含む（変換ミス）
  /→/,
  // ひらがな1文字
  /^[ぁ-ん]$/,
  // カタカナ1文字
  /^[ァ-ヶー]$/,
  // 漢字1文字（苗字だけなど）
  /^[一-龯]$/,
  // ハイフンのみ
  /^-+$/,
  // 空白のみ
  /^\s*$/,
  // 「---」などのプレースホルダー
  /^-{2,}$/,
  // 「...」などのプレースホルダー
  /^\.{2,}$/,
  // 「***」などのプレースホルダー
  /^\*{2,}$/,
  // HTMLタグが残っている
  /<[^>]+>/,
  // URLが含まれている
  /https?:\/\//,
  // メールアドレスパターン
  /@[a-zA-Z0-9.-]+\.[a-zA-Z]/,
  // 「名無し」「匿名」など
  /^(名無し|匿名|不明|未定|なし|ナシ|無し)$/,
  // 数字とハイフンのみ（品番パターン）
  /^[A-Z0-9]+-[0-9]+$/i,
  // 記号のみ
  /^[!@#$%^&*()_+=\[\]{}|\\:";'<>?,./～・。、「」『』【】]+$/,
];

/**
 * 無効な演者名の完全一致リスト
 */
const INVALID_NAMES: string[] = [
  '他',
  'デ',
  'ラ',
  'ゆ',
  'な',
  '素人',
  '---',
  '-',
  '.',
  '..',
  '...',
  '*',
  '**',
  '***',
  'etc',
  'etc.',
  'その他',
  'unknown',
  'Unknown',
  'UNKNOWN',
  'N/A',
  'n/a',
  'TBA',
  'TBD',
  '出演者',
  '出演',
  '女優',
  '男優',
  'AV女優',
  '名前',
  'name',
  'Name',
  '（出演者）',
  '複数出演',
  '多数出演',
  '他多数',
  '他複数',
  'ほか',
  'ほか多数',
  'など',
  '素人娘',
  '美女達',
  '新人女優',
  '限定',
  '特典版',
  'エース',
  '我が家',
  // タイトル断片（v2で追加）
  'セフレ', '美女の', 'ピンク', 'セクシ', '出して', 'まさか', '奇跡の',
  'スタイル抜群', 'キャバ嬢', '巨乳美女', 'もちゃ', '最初で最後', 'アイドル顔の',
  '奥さん', '大学生', 'デカ尻', '初体験', '高身長', '小悪魔', '放課後',
  'お願い', '連続中出し', 'キュー', 'レディ', '女子社員', '感じる',
  '顔出し', 'ファイ', '激ピストン', 'ミニマム', '汗だく', '地下アイドル',
  '超敏感', '激イキ', 'レベル', '乱れる', 'グラマ', 'もっと',
  '垂れ流し', '丸見え', '最高級', 'ダンス',
  // 「〜の」パターンのタイトル断片
  '素人娘の', '彼女の', '秘密の', '禁断の', '熟女と', 'ギャルの',
  'カメラの前で', 'ママに内緒の', '素人娘たちの', '魅惑の', '女性の', '世界の',
  // その他
  '独占', '数量限定', '新人', '流出', '後編', '前編', '本物', '完全',
  // v4で追加
  'オフィスレデ', 'グラドル', 'セール', 'インタビュ', '低身長',
  'グラビアアイ', 'ダンサ', '今まで', '戸惑い', 'ノンストップ',
  '撮影に', 'ナウン', 'スパンキング', 'やりたい放題', 'おっぱいの',
  '女子アナ', 'やっぱり', 'キャンギャル', '女子高生',
  // v5で追加 - シリーズ名・レーベル名
  '俺の素人', 'P-WIFE', 'マジ軟派、初撮。', 'ラグジュTV', 'MOON FORCE',
  '黒船提督', '鉄人2号さん', 'しろうとまんまん', 'ゲリラ', '熟蜜のヒミツ',
  '五反田マングース', 'ぎがdeれいん', 'すももちゃん', 'シロウトタッチ',
  'いんすた', 'はめチャンネル', '白完素人', '素人道', '熟女楽園',
  '超素人', '熟女市場', '人妻汁', 'ガチ素人', '素人物語', '熟女A',
  '人妻願望', '素人なう', '℃素人', '素人図鑑', '海ナンパ', '熟女専科',
  '人妻探訪', '痴女活', 'S級素人', '人妻なう', '素人専科', 'ドM痴女',
  '素人喫茶', 'ギャルR', '人妻道',
  // v5で追加 - ジャンル名・プレイ名
  'オナニー', 'スレンダー', '巨乳', '爆乳', '美乳', '貧乳', '中出し', '顔射',
  'フェラ', '手コキ', 'パイズリ', '痴女', '熟女', '人妻', 'ギャル',
  '調教', '緊縛', 'ナンパ', '盗撮', '潮吹き', '絶頂', 'アナル', 'センズリ',
  'イキ', '昇天', '騎乗位', 'バック', '正常位', '巨尻', '美尻', 'パイパン',
  '剃毛', '美少女', 'ロリ', '淫乱', '変態', 'ドM', 'ドS', 'エステ', 'マッサージ',
  '風俗', 'デリヘル', 'ロリ系', 'ギャル系', 'ノンケ', 'ビキニ', 'ヤンキ',
  'ボイン', 'バニー', 'シャワ', 'アスリ', 'チュー', 'ブルマ', 'ボンデ',
  'ヒップ', 'シネマ', 'アナニ',
  // v5で追加 - Wiki編集用語
  '編集', '総合', '一般', '仮名', '添付', '白人', '履歴', '設定',
  // v5で追加 - その他無効
  '人妻さん', '素人ナンパ', 'センズリ鑑賞', '素人さ', 'センズリ見て',
  '素人セ', '巨乳妻', '素人初撮り生', '黒ギャル', '何度もイキま',
  '素人娘のフェ', 'アナル舐め', '素人限定', 'イキオナニー', 'センズリ見せ',
  '人妻ナンパ中', 'センズリを見', '裏風俗', '美少女と', '素人ナンパト',
  '元祖素人初撮', 'ウブな素人娘', 'アナル拡張', '僕のセンズリ', '素人カップル',
  '爆乳の', '素人酔った人', '美熟女ナンパ', '素人四畳半生', 'アナル無',
  '素人レズナン', '貧乳美', '五十路熟女の', '美少女たちの', '美少女いたず',
  '極太ディルドオナニー',
  // v6で追加 - ジャンル名・属性名
  'プライベート', 'ストッキング', 'ペニバン', 'スカトロ', 'フィスト',
  'リモバイ', 'リラクゼ', 'ガリガリ', 'カリスマ', 'ツンデレ', 'ブロンド',
  'アラフォ', 'レズキス', 'タクシ', 'ロングブ', 'ブラック',
  '出会い系', '威圧系', '囁き系', 'キャリア系', '豊満系',
  // v6で追加 - 短縮形・断片
  'ニュ', 'ファー', 'フリ',
  // v6で追加 - 男性名（外国人名/よくある誤検出）
  'リュウ', 'シロウ', 'マイク', 'ジョン', 'マサト', 'イアン', 'ワタル',
  'ヒロアキ', 'ケイスケ', 'ジャック',
];

/**
 * タイトル断片を検出するためのパターン
 * クローラーが誤って演者名としてパースした文字列を弾く
 *
 * 注意: 素人系の仮名（素人まりあ、熟女れいこ等）は許可するため、
 * 「素人」「熟女」「人妻」などは単体でINVALID_NAMESに入れるが、
 * 名前の一部としては許可する
 */
const SUSPICIOUS_PHRASES: RegExp[] = [
  // 素人系タイトル断片（単体ではなく、明確にタイトルと分かるパターンのみ）
  /初投稿/, /初めて/, /初体験/, /デビュー/,
  /美女限定/, /美女達/, /美人妻/, /絶景/,
  // 注: /素人/, /熟女/, /人妻/, /奥様/, /若妻/, /新妻/ は削除（仮名に含まれることがあるため）

  // 企画系
  /企画/, /総集編/, /スペシャル/, /シリーズ/, /コレクション/, /ベスト/, /限定/, /特典/,
  /プレミアム/, /ドキュメント/,

  // ナンパ・盗撮系
  /ナンパ/, /逆ナン/, /街角/, /路上/, /マジック/, /ミラー号/,
  /盗撮/, /隠し撮り/, /覗き/, /のぞき/, /ガチナンパ/,

  // プレイ系
  /調教/, /奴隷/, /家畜/, /拘束/, /緊縛/, /催眠/, /洗脳/,
  /フェラ/, /手コキ/, /パイズリ/, /中出し/, /顔射/, /アナル/, /剃毛/,
  /オナニ/, /センズリ/, /騎乗/, /バック/, /正常位/,
  /潮吹き/, /イキ/, /絶頂/, /昇天/, /乳首/,
  /ズボズボ/, /ハメ/, /挿入/, /射精/, /精液/,

  // 属性系（ただし「美少女」は名前の一部になりうるので削除）
  /巨乳/, /爆乳/, /貧乳/, /美乳/, /巨尻/, /美尻/,
  /ロリ/, /ギャル/, /JK/, /JD/, /OL/, /女子大生/, /女子校生/,
  /痴女/, /淫乱/, /ドM/, /ドS/, /変態/, /ドスケベ/, /エッチな/,
  /欲求不満/, /ヤリマン/, /セックス/, /パイパン/, /ミニスカ/,

  // 場所・シチュエーション
  /温泉/, /旅館/, /ホテル/, /自宅/, /会社/, /学校/,
  /エステ/, /マッサ/, /サロン/, /風俗/, /ビジネスホテ/,
  /メンズエステ/, /オイルエステ/, /レズエステ/,

  // ジャンル名
  /レズビアン/, /くすぐり/, /コスプレイヤ/, /おしっこ/,

  // 助詞で終わる（タイトル断片の特徴）
  /[のにをではがともへや]$/,

  // 「〜な〜」「〜の〜」パターン（5文字以上でかな/カナのみ）
  /^[ぁ-んァ-ヶー]{2,}の[ぁ-んァ-ヶー]{2,}$/,
  /^[ぁ-んァ-ヶー]{2,}な[ぁ-んァ-ヶー]{2,}$/,

  // 動詞で終わる（長い文字列のみ、7文字以上）
  // 注: 「める」「ゆる」などの名前は許可するため、パターンを厳格化
  /^.{7,}[るすくぬつうぐずぶ]$/,

  // よくある誤検出パターン
  /見てる/, /魅惑/, /合間/, /快楽/, /おじさん/, /就職/, /買い物/,
  /グラドル/, /流出/, /我が家/, /激エロ/, /エース/,
  /エロすぎ/, /エロ過ぎ/, /極エロ/, /どエロ/, /エロエロ/,
];

/**
 * 演者名として有効かどうかをチェック
 * @param name 演者名
 * @returns 有効な場合true
 */
export function isValidPerformerName(name: string | null | undefined): boolean {
  if (!name) return false;

  const trimmed = name.trim();

  // 空文字チェック
  if (trimmed.length === 0) return false;

  // 最小長チェック（2文字以上必要）
  if (trimmed.length < 2) return false;

  // 無効な名前の完全一致チェック
  if (INVALID_NAMES.includes(trimmed)) return false;

  // 無効なパターンチェック
  for (const pattern of INVALID_PATTERNS) {
    if (pattern.test(trimmed)) return false;
  }

  // タイトル断片チェック（長さ5文字以上の場合のみ適用）
  if (trimmed.length >= 5) {
    for (const phrase of SUSPICIOUS_PHRASES) {
      if (phrase.test(trimmed)) return false;
    }
  }

  return true;
}

/**
 * 演者名を正規化（クリーンアップ）
 * @param name 演者名
 * @returns 正規化された演者名（無効な場合null）
 */
export function normalizePerformerName(name: string | null | undefined): string | null {
  if (!name) return null;

  let normalized = name.trim();

  // 全角スペースを半角に
  normalized = normalized.replace(/　/g, ' ');

  // 日本語名の場合、スペースを削除（「波 多 野 結 衣」→「波多野結衣」）
  // 日本語文字（ひらがな、カタカナ、漢字）のみで構成されている場合
  if (/^[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF\s]+$/.test(normalized)) {
    normalized = normalized.replace(/\s+/g, '');
  } else {
    // 英語名など（スペースを保持するが、連続する空白は1つに）
    normalized = normalized.replace(/\s+/g, ' ');
  }

  // 前後の記号を削除
  normalized = normalized.replace(/^[・●○◎◇◆□■△▲▽▼※☆★♪♫【】「」『』（）()［］\[\]]+/, '');
  normalized = normalized.replace(/[・●○◎◇◆□■△▲▽▼※☆★♪♫【】「」『』（）()［］\[\]]+$/, '');

  // 括弧内の読み仮名を削除（例: "山田花子（やまだはなこ）" → "山田花子"）
  normalized = normalized.replace(/[（(][ぁ-んァ-ヶー]+[）)]/g, '');

  // 「AKA」や「別名」などを削除
  normalized = normalized.replace(/\s*(aka|a\.k\.a\.?|別名|旧名|現|旧)\s*[:：]?\s*/gi, ' ');

  // 再度トリム
  normalized = normalized.trim();

  // バリデーション
  if (!isValidPerformerName(normalized)) {
    return null;
  }

  return normalized;
}

/**
 * 演者名のリストをパースして有効な名前のみ返す
 * @param rawPerformers 生の演者名文字列（カンマ区切りなど）
 * @param delimiters 区切り文字のパターン（デフォルト: カンマ、読点、スラッシュ）
 * @returns 有効な演者名の配列
 */
export function parsePerformerNames(
  rawPerformers: string | null | undefined,
  delimiters: RegExp = /[、,\/・\n\t]+/
): string[] {
  if (!rawPerformers) return [];

  const names = rawPerformers.split(delimiters);
  const validNames: string[] = [];

  for (const name of names) {
    const normalized = normalizePerformerName(name);
    if (normalized && !validNames.includes(normalized)) {
      validNames.push(normalized);
    }
  }

  return validNames;
}

/**
 * 演者名が有効で、かつ商品タイトルと異なることを確認
 * @param performerName 演者名
 * @param productTitle 商品タイトル
 * @returns 有効な場合true
 */
export function isValidPerformerForProduct(
  performerName: string | null | undefined,
  productTitle: string | null | undefined
): boolean {
  if (!isValidPerformerName(performerName)) return false;

  // タイトルと完全一致する場合は無効（タイトルを誤って演者名として取得している可能性）
  if (productTitle && performerName?.trim().toLowerCase() === productTitle.trim().toLowerCase()) {
    return false;
  }

  return true;
}
