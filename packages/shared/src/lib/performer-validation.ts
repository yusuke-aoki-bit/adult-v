/**
 * 演者名のバリデーションと正規化ユーティリティ
 *
 * 全クローラーで共通して使用する演者名の検証・正規化ロジック
 */

// ============================================================
// カナ変換ユーティリティ（名寄せ用）
// ============================================================

/** ひらがな→カタカナ変換 */
export function hiraganaToKatakana(str: string): string {
  return str.replace(/[\u3041-\u3096]/g, (match) => String.fromCharCode(match.charCodeAt(0) + 0x60));
}

/** カタカナ→ひらがな変換 */
export function katakanaToHiragana(str: string): string {
  return str.replace(/[\u30a1-\u30f6]/g, (match) => String.fromCharCode(match.charCodeAt(0) - 0x60));
}

/**
 * 演者名の正規化キーを生成（重複検出用）
 *
 * 名前をカタカナ統一・スペース除去・半角統一した「正規化キー」を返す。
 * 同一人物の表記揺れ（「はたの ゆい」「ハタノユイ」「波多野結衣（はたのゆい）」）
 * が同じキーになることで、重複を検出できる。
 *
 * 注: 漢字名はそのまま保持（読み仮名がなければ変換不能）
 */
export function generateNormalizedKey(name: string): string {
  let key = name;

  // 全角英数字→半角
  key = key.replace(/[\uFF01-\uFF5E]/g, (ch) => String.fromCharCode(ch.charCodeAt(0) - 0xfee0));

  // ひらがな→カタカナに統一
  key = hiraganaToKatakana(key);

  // スペース・中黒を全て除去
  key = key.replace(/[\s　・]/g, '');

  // ダッシュ類統一
  key = key.replace(/[‐‑‒–—―−\-]/g, '');

  // 小文字統一
  key = key.toLowerCase();

  return key;
}

/**
 * 無効な演者名のパターン（事前コンパイル済み単一正規表現）
 * 個別パターンを | で結合して1回のtest()で判定
 */
const INVALID_PATTERN_COMBINED: RegExp = new RegExp(
  [
    '^[0-9]+$', // 数字のみ
    '^[a-zA-Z0-9_-]{1,4}$', // 短い英数字のみ（5文字未満）
    '^素人[0-9]*$', // 素人系の一般名称
    '^企画$', // 企画もの
    '^他$', // 「他」単体
    '→', // 矢印を含む（変換ミス）
    '^[ぁ-ん]$', // ひらがな1文字
    '^[ァ-ヶー]$', // カタカナ1文字
    '^[一-龯]$', // 漢字1文字
    '^-+$', // ハイフンのみ
    '^\\s*$', // 空白のみ
    '^\\.{2,}$', // 「...」プレースホルダー
    '^\\*{2,}$', // 「***」プレースホルダー
    '<[^>]+>', // HTMLタグ
    'https?://', // URL
    '@[a-zA-Z0-9.-]+\\.[a-zA-Z]', // メールアドレス
    '^(名無し|匿名|不明|未定|なし|ナシ|無し)$', // 匿名系
    '^[A-Z0-9]+-[0-9]+$', // 品番パターン
    '^[!@#$%^&*()_+=\\[\\]{}|\\\\:";\'<>?,./～・。、「」『』【】]+$', // 記号のみ
  ].join('|'),
  'i',
);

/**
 * 無効な演者名の完全一致セット（O(1)検索）
 */
const INVALID_NAMES: ReadonlySet<string> = new Set([
  '他',
  'デ',
  'ラ',
  'ゆ',
  'な',
  '素人',
  '---',
  '-',
  '.',
  '..',
  '...',
  '*',
  '**',
  '***',
  'etc',
  'etc.',
  'その他',
  'unknown',
  'Unknown',
  'UNKNOWN',
  'N/A',
  'n/a',
  'TBA',
  'TBD',
  '出演者',
  '出演',
  '女優',
  '男優',
  'AV女優',
  '名前',
  'name',
  'Name',
  '（出演者）',
  '複数出演',
  '多数出演',
  '他多数',
  '他複数',
  'ほか',
  'ほか多数',
  'など',
  '素人娘',
  '美女達',
  '新人女優',
  '限定',
  '特典版',
  'エース',
  '我が家',
  // タイトル断片（v2で追加）
  'セフレ',
  '美女の',
  'ピンク',
  'セクシ',
  '出して',
  'まさか',
  '奇跡の',
  'スタイル抜群',
  'キャバ嬢',
  '巨乳美女',
  'もちゃ',
  '最初で最後',
  'アイドル顔の',
  '奥さん',
  '大学生',
  'デカ尻',
  '初体験',
  '高身長',
  '小悪魔',
  '放課後',
  'お願い',
  '連続中出し',
  'キュー',
  'レディ',
  '女子社員',
  '感じる',
  '顔出し',
  'ファイ',
  '激ピストン',
  'ミニマム',
  '汗だく',
  '地下アイドル',
  '超敏感',
  '激イキ',
  'レベル',
  '乱れる',
  'グラマ',
  'もっと',
  '垂れ流し',
  '丸見え',
  '最高級',
  'ダンス',
  // 「〜の」パターンのタイトル断片
  '素人娘の',
  '彼女の',
  '秘密の',
  '禁断の',
  '熟女と',
  'ギャルの',
  'カメラの前で',
  'ママに内緒の',
  '素人娘たちの',
  '魅惑の',
  '女性の',
  '世界の',
  // その他
  '独占',
  '数量限定',
  '新人',
  '流出',
  '後編',
  '前編',
  '本物',
  '完全',
  // v4で追加
  'オフィスレデ',
  'グラドル',
  'セール',
  'インタビュ',
  '低身長',
  'グラビアアイ',
  'ダンサ',
  '今まで',
  '戸惑い',
  'ノンストップ',
  '撮影に',
  'ナウン',
  'スパンキング',
  'やりたい放題',
  'おっぱいの',
  '女子アナ',
  'やっぱり',
  'キャンギャル',
  '女子高生',
  // v5で追加 - シリーズ名・レーベル名
  '俺の素人',
  'P-WIFE',
  'マジ軟派、初撮。',
  'ラグジュTV',
  'MOON FORCE',
  '黒船提督',
  '鉄人2号さん',
  'しろうとまんまん',
  'ゲリラ',
  '熟蜜のヒミツ',
  '五反田マングース',
  'ぎがdeれいん',
  'すももちゃん',
  'シロウトタッチ',
  'いんすた',
  'はめチャンネル',
  '白完素人',
  '素人道',
  '熟女楽園',
  '超素人',
  '熟女市場',
  '人妻汁',
  'ガチ素人',
  '素人物語',
  '熟女A',
  '人妻願望',
  '素人なう',
  '℃素人',
  '素人図鑑',
  '海ナンパ',
  '熟女専科',
  '人妻探訪',
  '痴女活',
  'S級素人',
  '人妻なう',
  '素人専科',
  'ドM痴女',
  '素人喫茶',
  'ギャルR',
  '人妻道',
  // v5で追加 - ジャンル名・プレイ名
  'オナニー',
  'スレンダー',
  '巨乳',
  '爆乳',
  '美乳',
  '貧乳',
  '中出し',
  '顔射',
  'フェラ',
  '手コキ',
  'パイズリ',
  '痴女',
  '熟女',
  '人妻',
  'ギャル',
  '調教',
  '緊縛',
  'ナンパ',
  '盗撮',
  '潮吹き',
  '絶頂',
  'アナル',
  'センズリ',
  'イキ',
  '昇天',
  '騎乗位',
  'バック',
  '正常位',
  '巨尻',
  '美尻',
  'パイパン',
  '剃毛',
  '美少女',
  'ロリ',
  '淫乱',
  '変態',
  'ドM',
  'ドS',
  'エステ',
  'マッサージ',
  '風俗',
  'デリヘル',
  'ロリ系',
  'ギャル系',
  'ノンケ',
  'ビキニ',
  'ヤンキ',
  'ボイン',
  'バニー',
  'シャワ',
  'アスリ',
  'チュー',
  'ブルマ',
  'ボンデ',
  'ヒップ',
  'シネマ',
  'アナニ',
  // v5で追加 - Wiki編集用語
  '編集',
  '総合',
  '一般',
  '仮名',
  '添付',
  '白人',
  '履歴',
  '設定',
  // v5で追加 - その他無効
  '人妻さん',
  '素人ナンパ',
  'センズリ鑑賞',
  '素人さ',
  'センズリ見て',
  '素人セ',
  '巨乳妻',
  '素人初撮り生',
  '黒ギャル',
  '何度もイキま',
  '素人娘のフェ',
  'アナル舐め',
  '素人限定',
  'イキオナニー',
  'センズリ見せ',
  '人妻ナンパ中',
  'センズリを見',
  '裏風俗',
  '美少女と',
  '素人ナンパト',
  '元祖素人初撮',
  'ウブな素人娘',
  'アナル拡張',
  '僕のセンズリ',
  '素人カップル',
  '爆乳の',
  '素人酔った人',
  '美熟女ナンパ',
  '素人四畳半生',
  'アナル無',
  '素人レズナン',
  '貧乳美',
  '五十路熟女の',
  '美少女たちの',
  '美少女いたず',
  '極太ディルドオナニー',
  // v6で追加 - ジャンル名・属性名
  'プライベート',
  'ストッキング',
  'ペニバン',
  'スカトロ',
  'フィスト',
  'リモバイ',
  'リラクゼ',
  'ガリガリ',
  'カリスマ',
  'ツンデレ',
  'ブロンド',
  'アラフォ',
  'レズキス',
  'タクシ',
  'ロングブ',
  'ブラック',
  '出会い系',
  '威圧系',
  '囁き系',
  'キャリア系',
  '豊満系',
  // v6で追加 - 短縮形・断片
  'ニュ',
  'ファー',
  'フリ',
  // v6で追加 - 男性名（外国人名/よくある誤検出）
  'リュウ',
  'シロウ',
  'マイク',
  'ジョン',
  'マサト',
  'イアン',
  'ワタル',
  'ヒロアキ',
  'ケイスケ',
  'ジャック',
]);

/**
 * タイトル断片を検出するためのパターン（事前コンパイル済み単一正規表現）
 * クローラーが誤って演者名としてパースした文字列を弾く
 *
 * 個別RegExp配列をループするよりも単一正規表現の方が高速
 */
// 含有チェック用（部分一致で弾く語句）
const SUSPICIOUS_CONTAINS: RegExp = new RegExp(
  [
    // 素人系タイトル断片
    '素人',
    '初投稿',
    '初めて',
    '初体験',
    'デビュー',
    '美女限定',
    '美女達',
    '美人妻',
    '美少女',
    '絶景',
    '熟女',
    '人妻',
    '奥様',
    '若妻',
    '新妻',
    // 企画系
    '企画',
    '総集編',
    'スペシャル',
    'シリーズ',
    'コレクション',
    'ベスト',
    '限定',
    '特典',
    'プレミアム',
    'ドキュメント',
    // ナンパ・盗撮系
    'ナンパ',
    '逆ナン',
    '街角',
    '路上',
    'マジック',
    'ミラー号',
    '盗撮',
    '隠し撮り',
    '覗き',
    'のぞき',
    'ガチナンパ',
    // プレイ系
    '調教',
    '奴隷',
    '家畜',
    '拘束',
    '緊縛',
    '催眠',
    '洗脳',
    'フェラ',
    '手コキ',
    'パイズリ',
    '中出し',
    '顔射',
    'アナル',
    '剃毛',
    'オナニ',
    'センズリ',
    '騎乗',
    'バック',
    '正常位',
    '潮吹き',
    'イキ',
    '絶頂',
    '昇天',
    '乳首',
    'ズボズボ',
    'ハメ',
    '挿入',
    '射精',
    '精液',
    // 属性系
    '巨乳',
    '爆乳',
    '貧乳',
    '美乳',
    '巨尻',
    '美尻',
    'ロリ',
    'ギャル',
    'JK',
    'JD',
    'OL',
    '女子大生',
    '女子校生',
    '痴女',
    '淫乱',
    'ドM',
    'ドS',
    '変態',
    'ドスケベ',
    'エッチな',
    '欲求不満',
    'ヤリマン',
    'セックス',
    'パイパン',
    'ミニスカ',
    // 場所・シチュエーション
    '温泉',
    '旅館',
    'ホテル',
    '自宅',
    '会社',
    '学校',
    'エステ',
    'マッサ',
    'サロン',
    '風俗',
    'ビジネスホテ',
    'メンズエステ',
    'オイルエステ',
    'レズエステ',
    // ジャンル名
    'レズビアン',
    'くすぐり',
    'コスプレイヤ',
    'おしっこ',
    // よくある誤検出パターン
    '見てる',
    '魅惑',
    '合間',
    '快楽',
    'おじさん',
    '就職',
    '買い物',
    'グラドル',
    '流出',
    '我が家',
    '激エロ',
    'エース',
    'エロすぎ',
    'エロ過ぎ',
    '極エロ',
    'どエロ',
    'エロエロ',
  ].join('|'),
);

// 末尾・全体マッチ用の構造パターン（事前コンパイル）
const SUSPICIOUS_STRUCTURAL: RegExp =
  /[のにをではがともへや]$|^[ぁ-んァ-ヶー]{2,}の[ぁ-んァ-ヶー]{2,}$|^[ぁ-んァ-ヶー]{2,}な[ぁ-んァ-ヶー]{2,}$|[るすくむぬつうぐずぶ]$/;

/**
 * 仮名演者判定用の事前コンパイル済み正規表現
 * 9パターンを単一RegExpに結合（呼出し頻度が高いため最適化）
 */
const FAKE_PERFORMER_PATTERN: RegExp = new RegExp(
  [
    '^.{1,10}\\s+\\d{2}歳\\s+.+$', // パターン1: 名前 N歳 職業
    '^.{1,10}\\s+\\d{2}歳$', // パターン2: 名前 N歳
    '^.{1,10}[（(]\\d{2}歳[）)]', // パターン3: 名前（N歳）
    '^\\d{2}歳\\s+', // パターン4: N歳 職業
    '^\\d{2}歳$', // パターン5: N歳
    '^(モデル名?非公開|名前非公開|出演者非公開|非公開)$', // パターン6: 非公開系
    '[（(]仮名?[）)]', // パターン7a: （仮名）
    '\\s仮名$', // パターン7b: 仮名（末尾）
    '^\\d{2}代\\s+', // パターン8: 20代 OL
    '^(素人モデル|一般人|アマチュア|amateur|モデル|model)$', // パターン9: 匿名
  ].join('|'),
  'i',
);

/**
 * 仮名演者かどうかを判定
 * 「○○ N歳 職業」パターン、「モデル名非公開」等にマッチする名前を仮名と判断
 *
 * MGS/DUGA/SOKMIL/その他ASP共通で使用
 */
export function isFakePerformerName(name: string): boolean {
  return FAKE_PERFORMER_PATTERN.test(name);
}

/**
 * 演者名として有効かどうかをチェック
 * @param name 演者名
 * @returns 有効な場合true
 */
export function isValidPerformerName(name: string | null | undefined): boolean {
  if (!name) return false;

  const trimmed = name.trim();

  // 空文字チェック
  if (trimmed.length === 0) return false;

  // 最小長チェック（2文字以上必要）
  if (trimmed.length < 2) return false;

  // 無効な名前の完全一致チェック（Set: O(1)）
  if (INVALID_NAMES.has(trimmed)) return false;

  // 無効なパターンチェック（事前コンパイル済み単一正規表現）
  if (INVALID_PATTERN_COMBINED.test(trimmed)) return false;

  // タイトル断片チェック（長さ5文字以上の場合のみ適用）
  // 事前コンパイル済み単一正規表現で一括判定
  if (trimmed.length >= 5) {
    if (SUSPICIOUS_CONTAINS.test(trimmed)) return false;
    if (SUSPICIOUS_STRUCTURAL.test(trimmed)) return false;
  }

  return true;
}

/**
 * 演者名を正規化（クリーンアップ）
 * @param name 演者名
 * @returns 正規化された演者名（無効な場合null）
 */
export function normalizePerformerName(name: string | null | undefined): string | null {
  if (!name) return null;

  let normalized = name.trim();

  // 全角英数字を半角に変換（Ａ→A, ０→0 など）
  normalized = normalized.replace(/[\uFF01-\uFF5E]/g, (ch) => String.fromCharCode(ch.charCodeAt(0) - 0xfee0));

  // 全角スペースを半角に
  normalized = normalized.replace(/　/g, ' ');

  // ダッシュ類を統一（全角ダッシュ、長音記号以外のダッシュ → 半角ハイフン）
  // 注: カタカナ長音「ー」（U+30FC）は保持
  normalized = normalized.replace(/[‐‑‒–—―−]/g, '-');

  // 日本語名の場合、スペースを削除（「波 多 野 結 衣」→「波多野結衣」）
  // 日本語文字（ひらがな、カタカナ、漢字）のみで構成されている場合
  if (/^[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF\s]+$/.test(normalized)) {
    normalized = normalized.replace(/\s+/g, '');
  } else {
    // 英語名など（スペースを保持するが、連続する空白は1つに）
    normalized = normalized.replace(/\s+/g, ' ');
  }

  // 前後の記号を削除
  normalized = normalized.replace(/^[・●○◎◇◆□■△▲▽▼※☆★♪♫【】「」『』（）()［］\[\]]+/, '');
  normalized = normalized.replace(/[・●○◎◇◆□■△▲▽▼※☆★♪♫【】「」『』（）()［］\[\]]+$/, '');

  // 括弧内の読み仮名を削除（例: "山田花子（やまだはなこ）" → "山田花子"）
  normalized = normalized.replace(/[（(][ぁ-んァ-ヶー]+[）)]/g, '');

  // 括弧内の年齢を削除（例: "さくら（22歳）" → "さくら"、"花子(25)" → "花子"）
  normalized = normalized.replace(/[（(]\d{1,2}歳?[）)]/g, '');

  // 末尾の年齢パターンを削除（例: "ゆな 21歳" → "ゆな"）
  normalized = normalized.replace(/\s+\d{2}歳.*$/, '');

  // 「AKA」や「別名」などを削除
  normalized = normalized.replace(/\s*(aka|a\.k\.a\.?|別名|旧名|現|旧)\s*[:：]?\s*/gi, ' ');

  // 「仮名」「仮）」「(仮)」を削除
  normalized = normalized.replace(/[（(]仮[名）)]/g, '');
  normalized = normalized.replace(/\s*仮名$/g, '');

  // 再度トリム
  normalized = normalized.trim();

  // バリデーション
  if (!isValidPerformerName(normalized)) {
    return null;
  }

  return normalized;
}

/**
 * 演者名のリストをパースして有効な名前のみ返す
 * @param rawPerformers 生の演者名文字列（カンマ区切りなど）
 * @param delimiters 区切り文字のパターン（デフォルト: カンマ、読点、スラッシュ）
 * @returns 有効な演者名の配列
 */
export function parsePerformerNames(
  rawPerformers: string | null | undefined,
  delimiters: RegExp = /[、,\/・\n\t]+/,
): string[] {
  if (!rawPerformers) return [];

  const names = rawPerformers.split(delimiters);
  const validNames: string[] = [];

  for (const name of names) {
    const normalized = normalizePerformerName(name);
    if (normalized && !validNames.includes(normalized)) {
      validNames.push(normalized);
    }
  }

  return validNames;
}

/**
 * 演者名が有効で、かつ商品タイトルと異なることを確認
 * @param performerName 演者名
 * @param productTitle 商品タイトル
 * @returns 有効な場合true
 */
export function isValidPerformerForProduct(
  performerName: string | null | undefined,
  productTitle: string | null | undefined,
): boolean {
  if (!isValidPerformerName(performerName)) return false;

  // タイトルと完全一致する場合は無効（タイトルを誤って演者名として取得している可能性）
  if (productTitle && performerName?.trim().toLowerCase() === productTitle.trim().toLowerCase()) {
    return false;
  }

  return true;
}
