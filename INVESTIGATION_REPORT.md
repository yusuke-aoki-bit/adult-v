# データ品質調査レポート

**作成日**: 2025-11-25
**対象**: uncensored以外のクローラーの画像取得・名寄せ状況

---

## 📊 現状サマリー

### 商品データ
- **総商品数**: 143,241件 (アクティブ商品のみ)
- **無修正商品**: 8,973件 (別テーブルに分離済み)

### ASP別内訳
| ASP | 商品数 |
|-----|--------|
| DUGA | 135,895件 |
| MGS | 7,346件 |

---

## 🖼️ 画像データの問題

### 深刻な欠損状況
- **サムネイルなし**: 143,240件 / 143,241件 (**99.9%**)
- **product_imagesにデータなし**: 143,240件

### ASP別詳細
| ASP | サムネイルなし | 比率 |
|-----|---------------|------|
| DUGA | 135,895件 | 100% |
| MGS | 7,345件 | 99.99% |

---

## 👥 女優データの問題

- **女優情報なし**: 47,620件 / 143,241件 (33.2%)

---

## 🔍 原因分析

### DUGA (135,895件)

**問題**: CSV形式でデータ取得のため、画像情報が含まれていない

**現在のクローラー**: `download-and-seed-duga.ts`
- CSV: ✅ タイトル、出演者、価格、リリース日
- 画像: ❌ 含まれていない
- 商品ページスクレイピング: ❌ 未実装

**解決策**: ✅ **実装完了**
- `crawl-duga-images.ts` を作成
- DUGAページから画像を取得
- テスト: 5件成功 (100%)

### MGS (7,346件)

**問題**: クローラーは実装済みだが、大量実行されていない

**現在のクローラー**: `crawl-mgs.ts`
- HTMLスクレイピング: ✅ 実装済み
- 画像取得: ✅ サムネイル + サンプル画像
- product_images保存: ✅ 実装済み
- 女優情報取得: ✅ 実装済み

**解決策**: 一括クロールの実行が必要
- `crawl-mgs-list.ts` または `crawl-mgs-bulk.ts`
- 商品一覧ページから全商品URLを収集
- 各商品ページをクロール

---

## ✅ 実装済み機能

### 1. DUGAクローラー (`crawl-duga-images.ts`)
**機能**:
- DUGAページ (https://duga.jp/ppv/{productId}/) からスクレイピング
- サムネイル画像: `<meta property="og:image">`
- サンプル画像: `.sample-gallery img`
- `product_images`テーブルへ保存
- `products.defaultThumbnailUrl`を更新
- `raw_html_data`に生HTMLを保存

**実行方法**:
```bash
# テスト実行 (10件)
DATABASE_URL="..." npx tsx scripts/crawlers/crawl-duga-images.ts --limit 10

# 100件ずつバッチ実行 (推奨)
DATABASE_URL="..." npx tsx scripts/crawlers/crawl-duga-images.ts --limit 100 --offset 0
DATABASE_URL="..." npx tsx scripts/crawlers/crawl-duga-images.ts --limit 100 --offset 100

# 全件実行 (135,895件 - 約38時間想定)
DATABASE_URL="..." npx tsx scripts/crawlers/crawl-duga-images.ts
```

**パフォーマンス**:
- レート制限: 1秒/リクエスト
- 推定時間: 135,895件 × 1秒 = 約38時間

### 2. MGSクローラー (`crawl-mgs.ts`)
**既存実装**: ✅ 完備
- 画像取得ロジック実装済み
- 女優情報取得実装済み

**必要な作業**: 一括実行
- 7,346件の商品URL収集
- 各商品ページのクロール実行

---

## 📋 実施計画

### 優先度 🔴 高: DUGA画像取得

**対象**: 135,895件

**ステップ1**: 小規模テスト ✅ 完了
- 5件テスト実行 → 成功率 100%

**ステップ2**: バッチ実行 (推奨)
```bash
# 100件ずつ実行して進捗確認
for i in {0..1358}; do
  offset=$((i * 100))
  echo "Processing batch $i (offset $offset)"
  DATABASE_URL="..." npx tsx scripts/crawlers/crawl-duga-images.ts --limit 100 --offset $offset
  sleep 5  # バッチ間の待機
done
```

**ステップ3**: Cloud Run Jobsでの並列実行 (オプション)
- 複数ジョブで並列実行
- 範囲を分割 (例: 0-10000, 10001-20000, ...)
- 実行時間を大幅短縮

### 優先度 🟡 中: MGS商品再クロール

**対象**: 7,346件

**方法**:
1. `crawl-mgs-list.ts`で商品URL一覧を取得
2. `crawl-mgs.ts`で各商品をクロール

### 優先度 🟢 低: 女優名寄せ

**対象**: 47,620件 (女優情報なし商品)

**方法**:
1. `crawl-wiki-performers.ts` (av-wiki)
2. `crawl-nakiny.ts` (nakiny.com)

---

## 📈 期待される改善効果

### DUGA画像取得完了後
- サムネイルあり商品: **1件 → 135,896件** (135,895件増)
- カバレッジ: 0.0007% → **94.9%**

### MGS再クロール完了後
- サムネイルあり商品: 135,896件 → **143,241件** (7,345件増)
- カバレッジ: 94.9% → **100%** ✅

### 女優名寄せ完了後
- 女優情報あり商品: 95,621件 → **143,241件** (47,620件増)
- カバレッジ: 66.8% → **100%** ✅

---

## 🚀 次のアクション

1. ✅ DUGA画像クローラーのテスト (完了)
2. ⏳ DUGA画像バッチ実行の開始
3. ⏳ MGS商品一覧の取得
4. ⏳ MGS商品の再クロール実行
5. ⏳ 女優名寄せの実施

---

## 📝 備考

- 全クローラーは1秒/リクエストのレート制限を実装済み
- `raw_html_data`テーブルに生HTMLを保存し、将来の再解析に対応
- uncensored商品(8,973件)は別テーブルで管理中
