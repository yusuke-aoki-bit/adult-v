jQuery(function($) {

  //レポート・カレンダー
  $("#datepicker1,#datepicker2").datepicker( {
    closeText: '閉じる',
    prevText: '<前',
    nextText: '次>',
    currentText: '今日',
    monthNames: ['1月','2月','3月','4月','5月','6月',
    '7月','8月','9月','10月','11月','12月'],
    monthNamesShort: ['1月','2月','3月','4月','5月','6月',
    '7月','8月','9月','10月','11月','12月'],
    dayNames: ['日曜日','月曜日','火曜日','水曜日','木曜日','金曜日','土曜日'],
    dayNamesShort: ['日','月','火','水','木','金','土'],
    dayNamesMin: ['日','月','火','水','木','金','土'],
    weekHeader: '週',
    dateFormat: 'yy-mm-dd',
    isRTL: false,
    showMonthAfterYear: true,
    yearSuffix: '年',
    numberOfMonths: 3,
    showCurrentAtPos: 1,
    stepMonths: 1,
    showButtonPanel: true,
    yearRange: "-10:+10"
  } );

  $( ".input" ).focusin(function() {
    $( this ).find( "span" ).animate({"opacity":"0"}, 200);
  });

  $( ".input" ).focusout(function() {
    $( this ).find( "span" ).animate({"opacity":"1"}, 300);
  });

  //代理店全チェック
  $('.check-all').on('click', function() {
    if ($(this).prop('checked')) {
      allCheck('.check');
    } else {
      allRemove('.check');
    }
  });
  $('.check').on('click', function() {
    if ($(".check:not(:checked)").size() == 0) {
      allCheck('.check-all');
    } else {
      allRemove('.check-all');
    }
  });
  function allCheck(value) {
    $(value).prop('checked', true);
  }
  function allRemove(value) {
    $(value).prop('checked', false);
  }
  $('#message-send').click(function(){
    var check_count = $(".check:checked").size();
    if (check_count == 0 ){
      alert('チェックが入っていません。ご確認ください。')
      return false;
    }
  });

  //各ページ検索SELECT
  $(document).ready(function(){
    $("#medicom_id,#media_id").select2({
        width: "250px",
        language: {"noResults": function(){ return "見つかりません。";}},
        escapeMarkup: function (markup) { return markup; }
    });
  });

  //報酬全チェック
  $('.message-check-all').on('click', function() {
    if ($(this).prop('checked')) {
      allCheck('.message-check');
    } else {
      allRemove('.message-check');
    }
  });
  $('.message-check').on('click', function() {
    if ($(".message-check:not(:checked)").size() == 0) {
      allCheck('.message-check-all');
    } else {
      allRemove('.message-check-all');
    }
  });
  function allCheck(value) {
    $(value).prop('checked', true);
  }
  function allRemove(value) {
    $(value).prop('checked', false);
  }
  $('#message-del').click(function(){
    var check_count = $(".message-check:checked").size();
    if (check_count == 0 ){
      alert('チェックが入っていません。ご確認ください。')
      return false;
    }else{
      if( confirm( check_count + '件のメッセージを削除します。')){
          return true;
      }else{
        return false;
      }
    }
  });

  //メール
  $('.mail-flag').on('click', function() {
    if ($(this).prop('checked')) {
      var mail_flag = 'y';
    } else {
      var mail_flag = 'n';
    }
    $.get(
      "message_mail_flag.php", 
      { mail_flag: mail_flag },
      function(data){
        if(data == "y"){
          alert("通知をONにしました。");
        }else if(data == "n"){
          alert("通知をOFFにしました。");
        }
    });
  });

  $(".accordion_sec").click(function(){
    if($(this).is(".accordion_sec")){
      $("+dd",this).slideToggle("normal");
      $(this).removeClass("accordion_tit");
      $(this).addClass("accordion_min");
    }else{
      $("+dd",this).slideToggle("normal");
      $(this).removeClass("accordion_min");
      $(this).addClass("accordion_tit");
    }
  }).next().hide()

  //api
  $(document).ready(function(){
    $('.api-menu').click(function(){
      $(this).next('.api-st').stop(true, true).slideToggle();
    });
  });




  //プログラム・デバイス
  $(window).load(function(){
    $("#all").click(function() {
      $(".device").each(function() {
        this.disabled = !this.disabled;
      });
    });
  });

  //提携・公開ステータス
  $('[id=open_status]').on({
    change : function(){
        var formval = $(this).val();
        var alliance = $(this).parents('form').find('[id=alliance_status]');
        if(formval == "n"){
           $(alliance).attr('disabled','disabled');
        }else if(formval == "y"){
           $(alliance).removeAttr("disabled");
        }
    }
  });

  //提携・金額チェック
  $('[id=alliance_update]').on({
    click : function(){
        var program_buy_rate   = parseFloat( $(this).parents('form').find('[name=program_buy_rate]').val());
        var manager_buy_rate   = parseFloat( $(this).parents('form').find('[name=manager_buy_rate]').val());
        var program_buy_fixed  = parseFloat( $(this).parents('form').find('[name=program_buy_fixed]').val());
        var manager_buy_fixed  = parseFloat( $(this).parents('form').find('[name=manager_buy_fixed]').val());
        var program_click      = parseFloat( $(this).parents('form').find('[name=program_click]').val());
        var manager_click      = parseFloat( $(this).parents('form').find('[name=manager_click]').val());
        var program_join       = parseFloat( $(this).parents('form').find('[name=program_join]').val());
        var manager_join       = parseFloat( $(this).parents('form').find('[name=manager_join]').val());
        var program_appli      = parseFloat( $(this).parents('form').find('[name=program_appli]').val());
        var manager_appli      = parseFloat( $(this).parents('form').find('[name=manager_appli]').val());

        var forms   = $(this).parents('form');

        if( ! isNumber(program_buy_rate)){
          alert("報酬には数字を入力してください。");
        }else if( ! isNumber(manager_buy_rate)){
          alert("報酬には数字を入力してください。");
        }else if( ! isNumber(program_buy_fixed)){
          alert("報酬には数字を入力してください。");
        }else if( ! isNumber(manager_buy_fixed)){
          alert("報酬には数字を入力してください。");
        }else if( ! isNumber(program_click)){
          alert("報酬には数字を入力してください。");
        }else if( ! isNumber(manager_click)){
          alert("報酬には数字を入力してください。");
        }else if( ! isNumber(program_join)){
          alert("報酬には数字を入力してください。");
        }else if( ! isNumber(manager_join)){
          alert("報酬には数字を入力してください。");
        }else if( ! isNumber(program_appli)){
          alert("報酬には数字を入力してください。");
        }else if( ! isNumber(manager_appli)){
          alert("報酬には数字を入力してください。");
        }else if( program_buy_rate < manager_buy_rate){
          myRet = confirm("赤字になる項目\(商品購入 定率\)がありますがよろしいですか？");
          if ( myRet == true ){
            $(forms).submit();
          }
        }else if( program_buy_fixed < manager_buy_fixed){
          myRet = confirm("赤字になる項目\(商品購入 定額\)がありますがよろしいですか？");
          if ( myRet == true ){
            $(forms).submit();
          }
        }else if( program_click < manager_click){
          myRet = confirm("赤字になる項目\(クリック\)がありますがよろしいですか？");
          if ( myRet == true ){
            $(forms).submit();
          }
        }else if( program_join < manager_join){
          myRet = confirm("赤字になる項目\(会員登録\)がありますがよろしいですか？");
          if ( myRet == true ){
            $(forms).submit();
          }
        }else if( program_appli < manager_appli){
          myRet = confirm("赤字になる項目\(アプリDL\)がありますがよろしいですか？");
          if ( myRet == true ){
            $(forms).submit();
          }
        }else{
          $(forms).submit();
        }
    }
  });

  function isNumber(numVal){
    var pattern = /^[-]?([1-9]\d*|0)(\.\d+)?$/;
    return pattern.test(numVal);
  }

  //提携・一括変換
  $('#alliance input[type="text"]').keyup(function() {
    var fid = $(this).parents('form').attr("id");
    var val = $(this).val();
    var nm = $(this).attr("name");
    $('[name=data\\[' + fid + '\\]\\[' + nm + '\\]]').val(val);
  });

  $('#lump-open').click(function() {
    myRet = confirm("表示中のリストをすべて公開にしますがよろしいですか？");
    if ( myRet == true ){
      $('[name=md').val("open");
      $('#lump-form').submit();
    }
  });

  $('#lump-alliance').click(function() {
    myRet = confirm("表示中のリストをすべて提携にしますがよろしいですか？\n※未公開のリストには適用されません。");
    if ( myRet == true ){
      $('[name=md').val("alliance");
      $('#lump-form').submit();
    }
  });

  //マネージャー特定時インフルエンサー書換
  $('#manager_id').on({
    change : function(){
      var json_file = "";
      var manager_id = $('#manager_id').val();
      json_file = "./influencer_json.php?id=" + manager_id;
      $.getJSON(json_file,null,function(data){
        $('#influencer_id').children().remove();
        for(var i in data.result){
          $('#influencer_id').append("<option value='" +  data.result[i].option + "'>" + data.result[i].value + "</option>");
        }
      });
    }
  });
/*
  $(document).ready(function(){
    var url   = location.href;
    params    = url.split("?");
    spparams  = params[1].split("&");
    var paramArray = [];
    for ( i = 0; i < spparams.length; i++ ) {
        vol = spparams[i].split("=");
        paramArray.push(vol[0]);
        paramArray[vol[0]] = vol[1];
    }
    var manager_id = paramArray["manager_id"];
    var influencer_id = paramArray["influencer_id"];
    json_file = "influencer_json.php?id=" + manager_id;
    $.getJSON(json_file,null,function(data){
      $('#influencer_id').children().remove();
      for(var i in data.result){
        $('#influencer_id').append('<option value="'+ data.result[i].option + '"' + ((influencer_id == data.result[i].option)? ' selected' : '') + '>'+ data.result[i].value + '</option>');
      }
    });
  });
*/
  //削除時コメント
  $('[id=confirm]').click(function() {
    if (!confirm($(this).val())) {
      return false;
    }
    $( this ).parents('form').find('[name=rm]').val("y");
  });
});

